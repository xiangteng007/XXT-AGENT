# XXT-AGENT System Architecture v2.0

> Production-Grade Long-Running Real-Time Monitoring System

## ç³»çµ±æ¦‚è¦½

XXT-AGENT æ˜¯ä¸€å¥—æ•´åˆæ–°èã€ç¤¾ç¾¤ã€å¸‚å ´æ•¸æ“šçš„å³æ™‚ç›£æ§èˆ‡åˆ†æå¹³å°ï¼Œæ ¸å¿ƒåƒ¹å€¼åœ¨æ–¼ **Event Fusion Engine**ï¼Œèƒ½è‡ªå‹•åµæ¸¬ã€èåˆå¤šæºè¨Šè™Ÿä¸¦ç”¢ç”Ÿå¯è§£é‡‹çš„ FusedEventã€‚

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           XXT-AGENT Platform                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚   News      â”‚   â”‚   Social    â”‚   â”‚   Market    â”‚   â”‚   User      â”‚    â”‚
â”‚  â”‚  Sources    â”‚   â”‚  Platforms  â”‚   â”‚   Feeds     â”‚   â”‚ Dashboard   â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â–²â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚         â”‚                 â”‚                 â”‚                  â”‚           â”‚
â”‚         â–¼                 â–¼                 â–¼                  â”‚           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚           â”‚
â”‚  â”‚    News     â”‚   â”‚   Social    â”‚   â”‚   Market    â”‚          â”‚           â”‚
â”‚  â”‚  Collector  â”‚   â”‚ Dispatcher  â”‚   â”‚  Streamer   â”‚          â”‚           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜          â”‚           â”‚
â”‚         â”‚                 â”‚                 â”‚                  â”‚           â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚           â”‚
â”‚                          â–¼                                     â”‚           â”‚
â”‚                 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                           â”‚           â”‚
â”‚                 â”‚  Event Fusion   â”‚                           â”‚           â”‚
â”‚                 â”‚     Engine      â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤           â”‚
â”‚                 â”‚  (Core Value)   â”‚                           â”‚           â”‚
â”‚                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜                           â”‚           â”‚
â”‚                          â”‚                                     â”‚           â”‚
â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”‚           â”‚
â”‚         â–¼                â–¼                â–¼                   â”‚           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚           â”‚
â”‚  â”‚  Firestore  â”‚  â”‚   Pub/Sub   â”‚  â”‚  WebSocket  â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â”‚  â”‚(Hot Layer)  â”‚  â”‚(fused-events)â”‚  â”‚ (Real-time) â”‚                       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                       â”‚
â”‚         â”‚                â”‚                                                â”‚
â”‚         â”‚                â–¼                                                â”‚
â”‚         â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                         â”‚
â”‚         â”‚         â”‚   Alert     â”‚                                         â”‚
â”‚         â”‚         â”‚   Engine    â”‚â”€â”€â–º Telegram / LINE                      â”‚
â”‚         â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                         â”‚
â”‚         â”‚                                                                 â”‚
â”‚         â–¼                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                          â”‚
â”‚  â”‚  BigQuery   â”‚ (Cold Layer - Time Series)                               â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## æœå‹™æ¸…å–®

| æœå‹™ | åŠŸèƒ½ | éƒ¨ç½²ä½ç½® | ç‹€æ…‹ |
|------|------|----------|------|
| `dashboard` | Next.js å‰ç«¯ UI | Vercel | âœ… Active |
| `event-fusion-engine` | äº‹ä»¶èåˆæ ¸å¿ƒ | Cloud Run | âœ… Active |
| `news-collector` | æ–°èæ‹‰å–èˆ‡è™•ç† | Cloud Run | âœ… Active |
| `social-dispatcher` | ç¤¾ç¾¤è¼ªè©¢æ’ç¨‹ | Cloud Run | ğŸ”„ Upgrading |
| `market-streamer` | å¸‚å ´å³æ™‚ä¸²æµ | Cloud Run | âœ… Active |
| `alert-engine` | è­¦å ±æ¨æ’­å¼•æ“ | Cloud Run | âœ… Active |
| `ai-gateway` | AI API å®‰å…¨é–˜é“ | Cloud Run | ğŸ†• New |
| `telegram-command-bot` | Telegram æ©Ÿå™¨äºº | Cloud Run | âœ… Active |
| `quote-normalizer` | å ±åƒ¹æ¨™æº–åŒ– | Cloud Run | âœ… Active |

---

## è³‡æ–™åˆ†å±¤æ¶æ§‹

### Hot Layer: Firestore

- é…ç½®èˆ‡è¨­å®š
- æœ€æ–°ç‹€æ…‹å¿«ç…§
- FusedEvent ç´¢å¼• (ä¿ç•™ 7 å¤©)
- é€šçŸ¥ç‹€æ…‹
- ä½¿ç”¨è€… Watchlist

### Warm Layer: Cloud SQL (Future)

- æŠ€è¡“æŒ‡æ¨™è¨ˆç®—çµæœ
- äº‹ä»¶å›æº¯åˆ†æè³‡æ–™
- çŸ­æœŸæ­·å² (1-30 å¤©)

### Cold Layer: BigQuery

- K ç·šæ­·å² (1m/5m/1h/1d)
- å›æ¸¬è³‡æ–™é›†
- é•·æœŸåˆ†æèˆ‡å ±è¡¨
- äº‹ä»¶å½±éŸ¿çµ±è¨ˆ

---

## FusedEvent è¼¸å‡ºç®¡é“

FusedEvent æ˜¯ç³»çµ±çš„**ç¬¬ä¸€ç´šç”¢å“è¼¸å‡º**ï¼Œæ‰€æœ‰å¾ŒçºŒåŠŸèƒ½åœç¹å®ƒæ“´å……ã€‚

```
event-fusion-engine
       â”‚
       â”œâ”€â”€â–º Firestore: fused_events/{id}
       â”‚    (æŸ¥è©¢ã€Dashboard é¡¯ç¤º)
       â”‚
       â”œâ”€â”€â–º Pub/Sub: fused-events
       â”‚         â”‚
       â”‚         â”œâ”€â”€â–º alert-engine (è¨‚é–±)
       â”‚         â”‚         â”œâ”€â”€â–º Telegram (severity â‰¥ 7)
       â”‚         â”‚         â””â”€â”€â–º LINE (severity â‰¥ 7)
       â”‚         â”‚
       â”‚         â””â”€â”€â–º AI Agent (è¨‚é–±åšæ¨ç†/å ±å‘Š)
       â”‚
       â””â”€â”€â–º WebSocket broadcast
            (Dashboard å³æ™‚æ›´æ–°)
```

### FusedEvent Schema v2.0

```typescript
interface FusedEvent {
  id: string;                    // UUID
  ts: string;                    // ISO8601
  title: string;                 // äº‹ä»¶æ¨™é¡Œ
  severity: number;              // 1-10 (legacy)
  
  // å¯è§£é‡‹åš´é‡æ€§åˆ†æ•¸
  severityBreakdown: {
    scores: {
      market: number;            // 0-100 å¸‚å ´è¨Šè™Ÿ
      news: number;              // 0-100 æ–°èå½±éŸ¿
      social: number;            // 0-100 ç¤¾ç¾¤è²é‡
    };
    confidence: number;          // 0-1 äº¤å‰é©—è­‰å¼·åº¦
    finalScore: number;          // 0-100 åŠ æ¬Šå¾Œåˆ†æ•¸
    explain: string;             // AI è§£é‡‹
  };
  
  eventType: 'market' | 'news' | 'social' | 'fusion';
  sentiment: 'bullish' | 'bearish' | 'neutral' | 'mixed';
  
  symbols: string[];             // ç›¸é—œæ¨™çš„
  tags: string[];                // åˆ†é¡æ¨™ç±¤
  
  sources: {
    news?: NewsSource[];
    social?: SocialSource[];
    market?: MarketSource[];
  };
  
  confidence: number;
  actions?: Action[];
}
```

---

## å®‰å…¨æ¶æ§‹

### Gemini API Key ä¿è­·

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Dashboard  â”‚      â”‚ ai-gateway  â”‚      â”‚   Secret    â”‚
â”‚  (Next.js)  â”‚ â”€â”€â”€â–º â”‚(Cloud Run)  â”‚ â”€â”€â”€â–º â”‚   Manager   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   Frontend            Backend Only          GCP Secure

   POST /ai/summarize    GEMINI_API_KEY
   (ä¸å« Key)            (å¾ Secret Manager è®€å–)
```

**ç¦æ­¢äº‹é …**ï¼š

- âŒ å‰ç«¯ `NEXT_PUBLIC_GEMINI_*` ç’°å¢ƒè®Šæ•¸
- âŒ å‰ç«¯ç›´æ¥å‘¼å« Gemini API
- âŒ API Key ç¡¬ç·¨ç¢¼åœ¨ç¨‹å¼ç¢¼ä¸­

**æ­£ç¢ºåšæ³•**ï¼š

- âœ… æ‰€æœ‰ AI è«‹æ±‚é€é `ai-gateway` å¾Œç«¯æœå‹™
- âœ… API Key å­˜æ”¾æ–¼ GCP Secret Manager
- âœ… ä½¿ç”¨æœå‹™å¸³è™Ÿ IAM æ¬Šé™å­˜å–

---

## ç”Ÿç”¢å¼·åŒ–æ©Ÿåˆ¶

### Idempotency (å»é‡)

```typescript
// æ¯å€‹äº‹ä»¶ç”¢ç”Ÿå”¯ä¸€ key
const key = hash(`${source}:${symbol}:${timestamp}:${type}`);

// è™•ç†å‰æª¢æŸ¥
if (await idempotencyStore.exists(key)) {
  return; // è·³éé‡è¤‡
}

// è™•ç†å¾Œæ¨™è¨˜
await idempotencyStore.set(key, { ttl: 24 * 60 * 60 });
```

### DLQ (Dead Letter Queue)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Worker    â”‚ â”€â”€â–º â”‚ Main Topic  â”‚ â”€â”€â–º â”‚   Handler   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
                                               â”‚ å¤±æ•—
                                               â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚ Replay Tool â”‚ â—„â”€â”€ â”‚     DLQ     â”‚
                    â”‚ (æ‰‹å‹•è§¸ç™¼)  â”‚     â”‚ (ä¿ç•™ 7 å¤©) â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

DLQ Topics:

- `news-collector-dlq`
- `social-dispatcher-dlq`
- `event-fusion-dlq`

Replay æŒ‡ä»¤:

```bash
npm run replay:dlq -- --topic=news-collector --limit=100
```

### Health Check Endpoints

æ‰€æœ‰æœå‹™æä¾› `/health` endpoint:

```json
{
  "status": "healthy",
  "service": "event-fusion-engine",
  "version": "2.0.0",
  "uptime": 3600,
  "dependencies": {
    "firestore": "ok",
    "pubsub": "ok"
  }
}
```

---

## Pub/Sub Topics

| Topic | ç”¨é€” | è¨‚é–±è€… |
|-------|------|--------|
| `raw-news` | åŸå§‹æ–°èäº‹ä»¶ | event-fusion-engine |
| `raw-social` | åŸå§‹ç¤¾ç¾¤äº‹ä»¶ | event-fusion-engine |
| `raw-market` | åŸå§‹å¸‚å ´äº‹ä»¶ | event-fusion-engine |
| `fused-events` | èåˆå¾Œäº‹ä»¶ | alert-engine, AI Agent |
| `*-dlq` | å„æœå‹™ Dead Letter | Replay Tool |

---

## ç’°å¢ƒè®Šæ•¸

### Dashboard (Vercel)

```
NEXT_PUBLIC_FIREBASE_*       # Firebase å®¢æˆ¶ç«¯è¨­å®š
NEXT_PUBLIC_AI_GATEWAY_URL   # AI Gateway å¾Œç«¯ URL
```

### Cloud Run Services

```
GOOGLE_CLOUD_PROJECT         # GCP å°ˆæ¡ˆ ID
FIRESTORE_DATABASE           # Firestore è³‡æ–™åº«
GEMINI_SECRET_ID             # Secret Manager ä¸­çš„ Key ID
```

---

## éƒ¨ç½²æŒ‡å—

### Dashboard

```bash
cd dashboard
npm run build
# é€é Vercel Git æ•´åˆè‡ªå‹•éƒ¨ç½²
```

### Cloud Run Services

```bash
# å»ºç½®ä¸¦éƒ¨ç½²
gcloud run deploy <service-name> \
  --source . \
  --region asia-east1 \
  --project xxt-agent
```

### é©—è­‰

```bash
# æœ¬åœ°æ¸¬è©¦
npm run test

# é›²ç«¯ Smoke Test
./scripts/smoke-test-cloud.sh
```

---

## ç‰ˆæœ¬æ­·å²

| ç‰ˆæœ¬ | æ—¥æœŸ | è®Šæ›´æ‘˜è¦ |
|------|------|---------|
| v2.0.0 | 2026-01-17 | Production-grade upgrade: Gemini å®‰å…¨æ¶æ§‹ã€å¯è§£é‡‹ Severityã€DLQ/å»é‡ |
| v1.0.0 | 2026-01-15 | åˆå§‹ç™¼å¸ƒï¼šä¸‰é‡èåˆã€åŸºç¤ç›£æ§ |
