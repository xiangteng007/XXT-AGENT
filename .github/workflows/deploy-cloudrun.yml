name: Deploy Cloud Run Always-on Services + Terraform

on:
  workflow_dispatch:
  push:
    branches: ["main"]
    paths:
      - "services/**"
      - "infra/terraform/**"
      - ".github/workflows/deploy-cloudrun.yml"

env:
  REGION: asia-east1
  AR_REPO: ai-me-services

jobs:
  build-push-terraform:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Auth to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Setup gcloud
        uses: google-github-actions/setup-gcloud@v2

      - name: Configure Docker auth
        run: |
          gcloud auth configure-docker $REGION-docker.pkg.dev --quiet

      - name: Build & Push images
        run: |
          PROJECT_ID=$(gcloud config get-value project)
          for svc in market-streamer news-collector social-dispatcher social-worker event-fuser notifier ai-gateway; do
            echo "Building $svc..."
            docker build -t $REGION-docker.pkg.dev/$PROJECT_ID/$AR_REPO/$svc:latest services/$svc
            docker push $REGION-docker.pkg.dev/$PROJECT_ID/$AR_REPO/$svc:latest
          done

      - name: Terraform Init/Apply
        working-directory: infra/terraform
        run: |
          terraform init
          terraform apply -auto-approve
