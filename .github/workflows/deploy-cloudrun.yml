name: Deploy Cloud Run Always-on Services + Terraform

on:
  workflow_dispatch:
  push:
    branches: ["main"]
    paths:
      - "services/**"
      - "infra/terraform/**"
      - ".github/workflows/deploy-cloudrun.yml"

env:
  REGION: asia-east1
  AR_REPO: ai-me-services

jobs:
  build-push-terraform:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Auth to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Setup gcloud
        uses: google-github-actions/setup-gcloud@v2

      - name: Configure Docker auth
        run: |
          gcloud auth configure-docker $REGION-docker.pkg.dev --quiet

      - name: Build & Push changed services
        run: |
          PROJECT_ID=$(gcloud config get-value project)
          SERVICES="market-streamer news-collector social-dispatcher social-worker event-fusion-engine alert-engine ai-gateway trade-planner-worker telegram-command-bot quote-normalizer"
          BUILT=0

          # On workflow_dispatch, build all; on push, build only changed
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "Manual trigger - building ALL services"
            for svc in $SERVICES; do
              echo "üî® Building $svc..."
              docker build -t $REGION-docker.pkg.dev/$PROJECT_ID/$AR_REPO/$svc:latest services/$svc
              docker push $REGION-docker.pkg.dev/$PROJECT_ID/$AR_REPO/$svc:latest
              BUILT=$((BUILT + 1))
            done
          else
            CHANGED=$(git diff --name-only HEAD~1 HEAD)
            for svc in $SERVICES; do
              if echo "$CHANGED" | grep -q "services/$svc"; then
                echo "üî® Building $svc (changed)..."
                docker build -t $REGION-docker.pkg.dev/$PROJECT_ID/$AR_REPO/$svc:latest services/$svc
                docker push $REGION-docker.pkg.dev/$PROJECT_ID/$AR_REPO/$svc:latest
                BUILT=$((BUILT + 1))
              else
                echo "‚è≠Ô∏è Skipping $svc (no changes)"
              fi
            done
          fi

          echo "‚úÖ Built $BUILT service(s)"

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3

      - name: Terraform Init/Apply
        working-directory: infra/terraform
        env:
          TF_VAR_project_id: ${{ secrets.FIREBASE_PROJECT_ID }}
          TF_VAR_gemini_api_key: ${{ secrets.GEMINI_API_KEY }}
          TF_VAR_telegram_bot_token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TF_VAR_telegram_chat_id: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          terraform init
          terraform apply -auto-approve
